#!/usr/bin/env ruby
require 'rubygems'
require 'daemons'
require 'bundler/setup'
require 'optparse'
require 'ostruct'
require File.expand_path(File.dirname(__FILE__) + '/../lib/smeagol')

# Catch signals
Signal.trap('TERM') do
  Process.kill('KILL', 0)
end

# Parse options
options = Smeagol::OptionParser.parse(ARGV)

# Run the auto update process
if options.git && options.auto_update
  Thread.new do
    while true do
      sleep 86400
      Smeagol::Updater.update(options.git, options.gollum_path)
    end
  end
end

# Clear the cache
Smeagol::Cache.new(Gollum::Wiki.new(options.gollum_path)).clear()

# Run the web server
Smeagol::App.set(:gollum_path, options.gollum_path)
Smeagol::App.set(:git, options.git)
Smeagol::App.set(:cache_enabled, options.cache_enabled)
Smeagol::App.run!(:port => options.port)

